/* 
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/**
 * @author sadnana
 */

const SamplePSOAKB = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n" + "<!DOCTYPE Document [\n" + "<!ENTITY psoa  \"http://www.w3.org/2011/psoa#\">\n" + "<!ENTITY xs   \"http://www.w3.org/2001/XMLSchema#\">\n" + "<!ENTITY rdf  \"http://www.w3.org/1999/02/22-rdf-syntax-ns#\">\n" + "]>\n" + "<Document xmlns=\"&psoa;\">\n" + "<payload>\n" + "<Group>\n" + "<groupelement>\n" + "<Atom xmlns=\"&psoa;\">\n" + "<Member>\n" + "<instance>\n" + "<Const type=\"&psoa;iri\">http://example.org/#b</Const>\n" + "</instance>\n" + "<class>\n" + "<Const type=\"&psoa;iri\">http://example.org/#b</Const>\n" + "</class>\n" + "</Member>\n" + "</Atom>\n" + "</groupelement>\n" + "</Group>\n" + "</payload>\n" + "</Document>";

const Example1 = "this is example 1";
const Example2 = "this is example 2";
const Example3 = "this is example 3";
const Example4 = "this is example 4";

const App = "psoa2tptp-trans";
const Translate = "translate";
const Slash = "/";
const Equal = "=";
const Amp = "&";
const Qmark = "?";
const Doc = "document";
const Query = "query";
const Execute = "execute";
const nullf = function() {
};

var translatedKB;

var slash = function(s) {
	return Slash + s;
}
var append = function(s1, s2) {
	return s1 + s2;
}
const WS = "ws";

var service = function(service) {
	return append(WS, slash(service));
}
var htmlEncode = function(data) {
	return $('<div/>').text(data).html();
}
var htmlDecode = function(data) {
	return $('<div/>').html(data).text();
}
var param = function(key, val) {
	return append(key, append(Equal, val));
}
var amp = function(val) {
	return append(Amp, val);
}
var encode = encodeURIComponent;

var qs = function(url, params) {
	query = append(url, Qmark);
	query += params.shift();
	for (p in params) {
		query += amp(p);
	}
	return query;
}
var translate = function(kb, q, handler) {
	$.ajax({
		type : "POST",
		url : service(Translate),
		data : JSON.stringify(translateRequest(kb, q)),
		contentType : "application/json; charset=utf-8",
		success : function(data) {
			handler(data);
		}
	});
}
var translateRequest = function(psoa, query) {
	var d = (psoa) ? psoa : "";
	var q = (query) ? query : "";
	return {
		document : d,
		query : q,
		transType : transType()
	};
}
var executeQuery = function(handler) {
	$.ajax({
		type : "POST",
		contentType : "text/plain; charset=utf-8",
		url : service(Execute),
		data : tptpDoc(),
		success : handler
	});
}
var psoaKB = function() {
	return $("#PSOAKB").val();
}
var tptpDoc = function() {
	return $("#tptpOutput").val();
}
var psoaQuery = function() {
	return $("#PSOAQuery").val();
}
var transType = function() {
	return $("input[name=translatorType]:checked").val();
}
var filter = function(result) {
	var filteredResult = "";
	var startIndex, endIndex = 0;

	do {
		startIndex = result.lastIndexOf("%", result.indexOf("Proof ", endIndex));
		endIndex = result.lastIndexOf("%", result.indexOf("Statistics", startIndex));
		if (endIndex > 0)
			filteredResult += result.substring(startIndex, endIndex);
		else {
			filteredResult += result.substring(startIndex);
			break;
		}
	} while (true);
	return filteredResult;
}
// Set the button handler functions
$(document).ready(function() {

	$(function() {
		$("#menu").menu();
	});

	$("#PSOAKB").val(SamplePSOAKB);
	$("#example1Btn").click(function() {
		$("#PSOAKB").val(Example1);
	});
	$("#example2Btn").click(function() {
		$("#PSOAKB").val(Example2);
	});
	$("#example3Btn").click(function() {
		$("#PSOAKB").val(Example3);
	});
	$("#example4Btn").click(function() {
		$("#PSOAKB").val(Example4);
	});

	$('#transKBBtn').click(function() {
		translate(encode(psoaKB()), null, function(result) {
			translatedKB = result;
			$("#tptpOutput").val(translatedKB);
			$("#tabs").tabs('enable', 1);
			$("#tabs").tabs('select', 1);
		});
	});
	$("#transQueryBtn").click(function() {
		translate(null, encode(psoaQuery()), function(result) {
			$("#tptpOutput").val(translatedKB + "\n" + result);
		});
	});
	$("#resetKBBtn").click(function() {
		$("#PSOAKB").val("");
	});
	$("#showSampleKBBtn").click(function() {
		$("#PSOAKB").val(SamplePSOAKB);
	});
	$('#runQueryBtn').click(function() {
		executeQuery(function(result) {
			$("#vpOutput").val(filter(result));
			$("#tabs").tabs('enable', 2);
			$("#tabs").tabs('select', 2);
		});
	});
	$("#tabs").tabs({
		disabled : [1, 2]
	});
});
